@using HT.Utility;
@using HT.Model;
@model HT.Model.Model.PageResult<ht_news>
@{
                /**/

                ViewBag.Title = "货源信息";
                Layout = "~/Views/Shared/_Layout.cshtml";

}
@Html.Partial("_Header")
<div class="main">
    <div class="el_top">
        <div class="wrapper">
            <ul class="el_top_ul">
                <li><a class="start_city" v-on:click="showCity('start')">出发地<i></i></a></li>
                <li><a class="stop_city" v-on:click="showCity('stop')">到达地<i></i></a></li>
                <li><a class="car_type" v-on:click="showUseType()">用车车型<i></i></a></li>
                <li><a class="more" v-on:click="showCarLength()">更多<i></i></a></li>
            </ul>
        </div>
    </div>
    <div class="el_item" v-for="item in listData.list">
        <div class="wrapper">
            <div class="infor">
                <a v-bind:href="'/Project/GoodsSourceDetails/'+item.id">
                    <div class="infor_p1">
                        <span v-text="item.start_city"></span>
                        <i></i><!-- 中间的箭头符号 -->
                        <span v-text="item.stop_city"></span>
                        <em v-if="item.set_top>0">置顶</em>
                    </div>
                    <div class="infor_p2">
                        <i class="lab1" v-text="item.use_type"></i>
                        <i class="lab2" v-text="item.car_style"></i>
                        <i class="lab3" v-text="item.car_length+'米'"></i>
                        <i class="lab4" v-text="item.goods_type"></i>
                    </div>
                    <div class="infor_p3">
                        <div class="img">
                            <img v-bind:src="item.add_avatar" />
                        </div>
                        <div class="txt" v-text="item.contact_name">
                        </div>
                        <div class="date">
                            {{item.update_time|dateFormart('更新')}}
                        </div>
                    </div>
                </a>
                <div class="infor_p4">
                    <a v-bind:href="'tel://'+item.contact_phone">
                        <img src="/images/icon/icon02.png">
                        <span>打电话</span>
                    </a>
                </div>
            </div>
            <div class="flo">
                <ol class="clearfix">
                    <li>
                        <img src="/images/icon/icon03_1.png">
                        <span v-text="item.view_num"></span>
                    </li>
                    <li>
                        <img src="/images/icon/icon03_2.png">
                        <span v-text="item.praise_num"></span>
                    </li>
                    <li>
                        <img src="/images/icon/icon03_3.png">
                        <span v-text="item.share_num"></span>
                    </li>
                </ol>
            </div>
        </div>
    </div>
    <div class="use_type_box1 zhp_box hide"></div>
    <div class="use_type_box zhp_box hide">
        <div class="cty_box">
            <a href="javascript:;" v-bind:class="[{ 'cur':searchKey.use_type=='' }]"
               v-on:click="searchKey.use_type=''">不限</a>
            <a href="javascript:;" v-for="item in useTypeData"
               v-bind:class="[{ 'cur': item.title==searchKey.use_type }]"
               v-text="item.title" v-on:click="searchKey.use_type=item.title"></a>
        </div>
        <div class="sub_btn_box">
            <a href="javascript:void(0);" class="cancle" v-on:click="searchKey.use_type=''">重置</a>
            <a href="javascript:void(0);" class="confirm" v-on:click="confirm()">确定</a>
        </div>
    </div>
    <div class="start_box zhx_box tab-box hide">
        <ul class="zhx_box_title tab-title">
            <li v-bind:class="[{'active':select.startProvinceTab}]"
                v-on:click="selectTabProvince('start')">
                <a href="javascript:;">省</a>
            </li>
            <li v-bind:class="[{'active':!select.startProvinceTab}]"
                v-on:click="selectTabCity('start')">
                <a href="javascript:;">市</a>
            </li>
        </ul>
        <div v-bind:class="['province','clearfix','tab-content',{'hide':!select.startProvinceTab}]">
            <a href="javascript:;" v-for="item in cityData.get(0)"
               v-bind:class="[{ 'active': item==searchKey.start_province }]"
               v-text="item" v-on:click="selectProvince('start',item)">
            </a>
        </div>
        <div v-bind:class="['city','clearfix','tab-content',{'hide':select.startProvinceTab}]">
            <a href="javascript:;" v-for="item in cityData.getCitysByProvince(searchKey.start_province)"
               v-bind:class="[{ 'active':item==searchKey.start_city }]"
               v-text="item" v-on:click="selectCity('start',item)">
            </a>
        </div>
        <div class="sub_btn_box">
            <a href="javascript:void(0);" class="cancle" v-on:click="resetCity('start')">重置</a>
            <a href="javascript:void(0);" class="confirm" v-on:click="confirm()">确定</a>
        </div>
    </div>
    <div class="stop_box zhx_box tab-box hide">
        <ul class="zhx_box_title tab-title">
            <li v-bind:class="[{'active':select.stopProvinceTab}]"
                v-on:click="selectTabProvince('stop')">
                <a href="javascript:;">省</a>
            </li>
            <li v-bind:class="[{'active':!select.stopProvinceTab}]"
                v-on:click="selectTabCity('stop')">
                <a href="javascript:;">市</a>
            </li>
        </ul>
        <div v-bind:class="['province','clearfix','tab-content',{'hide':!select.stopProvinceTab}]">
            <a href="javascript:;" v-for="item in cityData.get(0)"
               v-bind:class="[{ 'active': item==searchKey.stop_province }]"
               v-text="item" v-on:click="selectProvince('stop',item)">
            </a>
        </div>
        <div v-bind:class="['city','clearfix','tab-content',{'hide':select.stopProvinceTab}]">
            <a href="javascript:;" v-for="item in cityData.getCitysByProvince(searchKey.stop_province)"
               v-bind:class="[{ 'active':item==searchKey.stop_city }]"
               v-text="item" v-on:click="selectCity('stop',item)">
            </a>
        </div>
        <div class="sub_btn_box">
            <a href="javascript:void(0);" class="cancle" v-on:click="resetCity('stop')">重置</a>
            <a href="javascript:void(0);" class="confirm" v-on:click="confirm()">确定</a>
        </div>
    </div>
    <div class="car_length_box zhj_box hide">
        <div class="cty_box">
            <p>车长<span>（米）</span></p>
            <a href="javascript:;" v-bind:class="[{ 'cur':searchKey.car_length=='' }]"
               v-on:click="searchKey.car_length=''">不限</a>
            <a href="javascript:;" v-for="item in carLengthData"
               v-bind:class="[{ 'cur': item.title==searchKey.car_length }]"
               v-text="item.title" v-on:click="searchKey.car_length=item.title"></a>
            @*<a href="javascript:;" class="m_btn">更多</a>*@
        </div>

        <div class="cty_box">
            <p>车型</p>
            <a href="javascript:;" v-bind:class="[{ 'cur':searchKey.car_style=='' }]"
               v-on:click="searchKey.car_style=''">不限</a>
            <a href="javascript:;" v-for="item in carStyleData"
               v-bind:class="[{ 'cur': item.title==searchKey.car_style }]"
               v-text="item.title" v-on:click="searchKey.car_style=item.title"></a>
        </div>
        <div class="sub_btn_box">
            <a href="javascript:void(0);" class="cancle"
               v-on:click="searchKey.car_length='';searchKey.car_style='';">重置</a>
            <a href="javascript:void(0);" class="confirm" v-on:click="confirm()">确定</a>
        </div>
    </div>
</div>

@Html.Partial("_Footer")
@Html.Partial("_CityJs")
<script>
    var listVm = new Vue({
        el: '.main',
        data: {
            listData: {
                total: 0,
                list: []
            },
            isLoading: true,
            //isLoadingLayer: -1,
            isLoadAll: false,
            searchKey: {
                cateid: 1,
                start_province: '',
                start_city: '',
                stop_province: '',
                stop_city: '',
                use_type: '',
                car_length: '',
                car_style: '',
                page: 1,
                rows: 5
            },
            select: {
                startProvinceTab: true,
                stopProvinceTab: true
            },
            cityData: dsy,
            useTypeData:[],
            carLengthData:[],
            carStyleData:[]
        },
        methods: {
            init: function () {
                this.bindScroll();
                this.loadData();
                this.loadCateData('use_type', 1);
                this.loadCateData('car_length', 4);
                this.loadCateData('car_style', 16);
            },
            loadData: function () {
                var _this = this;
                _this.isLoading = true;
                //_this.isLoadingLayer = layer.load(0);
                $.ajax({
                    type: 'post',
                    url: '/Project/BaseNewsList',
                    data: _this.searchKey,
                    dataType: 'json',
                    success: function (resp) {
                        _this.isLoading = false;
                        //layer.close(_this.isLoadingLayer);
                        if (resp.status) {
                            if (resp.result.list.length == 0) {
                                _this.isLoadAll = true;
                            } else {
                                _this.listData.list = _this.listData.list.concat(resp.result.list);
                            }
                            _this.listData.total = resp.result.total;
                            //console.log(_this.listData.list);
                        }
                    }
                });
            },
            bindScroll: function () {
                //console.log($(window).scrollTop());
                var _this = this;
                $(window).bind('scroll', function (e) {
                    var _wh = $(window).height();
                    var _st = $('body').get(0).scrollTop;
                    var _sh = $('body').get(0).scrollHeight;
                    if ((_sh - _st - _wh < 10) && (!_this.isLoadAll)) {
                        _this.loadMore();
                    }
                });
            },
            loadMore: function () {
                if (this.listData.list.length >= this.listData.total) return;
                this.searchKey.page++;
                this.loadData();
            },
            searchData: function () {
                var _this = this;
                _this.listData.total = 0;
                _this.listData.list = [];
                _this.searchKey.page = 1;
                _this.loadData();
            },
            loadCateData: function (code, cid) {
                var _this = this;
                $.ajax({
                    type: 'post',
                    url: '/Home/CateList',
                    data: { cid: cid},
                    dataType: 'json',
                    success: function (resp) {
                        if (resp.status) {
                            if (code == 'use_type') _this.useTypeData = resp.result;
                            if (code == 'car_length') _this.carLengthData = resp.result;
                            if (code == 'car_style') _this.carStyleData = resp.result;
                        }
                    }
                });
            },
            showCity: function (code) {
                var _title = code == 'start' ? '出发地' : '目的地';
                layer.open({
                    type: 1,
                    title: _title,
                    content: $('.' + code+'_box'),
                    offset: 'lb',
                    area: ['100%', '500px'],
                    shade: 0.5,
                    scrollbar: false,
                    anim: 2
                });
            },
            showUseType: function () {
                layer.open({
                    type: 1,
                    title: '用车类型',
                    content: $('.use_type_box'),
                    offset: 'lb',
                    area: ['100%', 'auto'],
                    shade: 0.5,
                    scrollbar: false,
                    anim: 2
                });
            },
            showCarLength: function () {
                layer.open({
                    type: 1,
                    title: '货源筛选',
                    content: $('.car_length_box'),
                    offset: 'lb',
                    area: ['100%', 'auto'],
                    shade: 0.5,
                    scrollbar: false,
                    anim: 2
                });
            },
            selectProvince: function (code, item) {
                var _this = this;
                if (code == 'start') {
                    if (_this.searchKey.start_province != item) _this.searchKey.start_city = '';
                    _this.searchKey.start_province = item;
                    _this.select.startProvinceTab = false;

                } else {
                    if (_this.searchKey.stop_province != item) _this.searchKey.stop_city = '';
                    _this.searchKey.stop_province = item;
                    _this.select.stopProvinceTab = false;

                }
            },
            selectCity: function(code, item) {
                var _this = this;
                if (code == 'start') {
                    _this.searchKey.start_city = item;
                } else {
                    _this.searchKey.stop_city = item;
                }
            },
            selectTabProvince: function (code) {
                var _this = this;
                if (code == 'start') {
                    _this.select.startProvinceTab = true;
                } else {
                    _this.select.stopProvinceTab = true;
                }
            },
            selectTabCity: function (code) {
                var _this = this;
                if (code == 'start') {
                    if (_this.searchKey.start_province == '') return;
                    _this.select.startProvinceTab = false;
                } else {
                    if (_this.searchKey.stop_province == '') return;
                    _this.select.stopProvinceTab = false;
                }
            },
            resetCity: function (code) {
                var _this = this;
                if (code == 'start') {
                    _this.select.startProvinceTab = true;
                    _this.searchKey.start_province = '';
                    _this.searchKey.start_city = '';
                } else {
                    _this.select.stopProvinceTab = true;
                    _this.searchKey.stop_province = '';
                    _this.searchKey.stop_city = '';
                }
            },
            confirm: function (code) {
                var _this = this;
                layer.closeAll();
                _this.searchData();
            }
        }
    });

    listVm.init();
    //var start = [-1, -1, -1];
    //var stop = [-1, -1, -1];
    //var cityshow = '';
    //var use_type = '';
    //var car_length = '';
    //var car_style = '';
    
    $(function () {
        //省市区选择
        var _dsy = dsy.get(0);
        //$.each(_dsy, function () {
        //    $('.zhx_box .province').append('<a href="javascript:;">' + this + '</a>');
        //});
        //$('.zhx_box .province a').click(function () {
        //    if ($(this).hasClass("active")) {
        //        $('.zhx_box .zhx_box_title li').eq(0).removeClass("active");
        //        $('.zhx_box .zhx_box_title li').eq(1).addClass("active");
        //        $('.zhx_box .province').hide();
        //        $('.zhx_box .city').show();
        //        return;
        //    }
        //    var _index = $(this).index();
        //    if (cityshow == 'start') start[0] = _index;
        //    if (cityshow == 'stop') stop[0] = _index;
        //    var _cdsy = dsy.get('0_' + _index);
        //    $('.zhx_box .city').html('');
        //    $.each(_cdsy, function () {
        //        $('.zhx_box .city').append('<a href="javascript:;">' + this + '</a>');
        //    });
        //    $('.zhx_box .zhx_box_title li').eq(0).removeClass("active");
        //    $('.zhx_box .zhx_box_title li').eq(1).addClass("active");
        //    $('.zhx_box .province').find(".active").removeClass("active");
        //    $(this).addClass("active");
        //    $('.zhx_box .province').hide();
        //    $('.zhx_box .city').show();
        //    $('.zhx_box .zhx_box_title .click-off').removeClass("click-off");
        //})

        //$('.zhx_box .city a').click(function () {
        //    if ($(this).hasClass("active")) return;
        //    var _index = $(this).index();
        //    if (cityshow == 'start') start[1] = _index;
        //    if (cityshow == 'stop') stop[1] = _index;
        //    $('.zhx_box .city').find(".active").removeClass("active");
        //    $(this).addClass("active");
        //})

        //$(".start_city").click(function () {
        //    cityshow = 'start';
        //    if (start[0] == -1) {
        //        $('.zhx_box .zhx_box_title li').eq(1).addClass("click-off");
        //        $('.zhx_box .province .active').removeClass("active");
        //        $('.zhx_box .city .active').removeClass("active");
        //        $('.zhx_box .zhx_box_title .active').removeClass("active");
        //        $('.zhx_box .zhx_box_title li').eq(0).addClass("active");
        //        $('.zhx_box .province').show();
        //        $('.zhx_box .city').hide();

        //    } else {
        //        var _cdsy = dsy.get('0_' + start[0]);
        //        $('.zhx_box .province .active').removeClass("active");
        //        $('.zhx_box .province a').eq(start[0]).addClass("active");
        //        $('.zhx_box .city').html('');
        //        $.each(_cdsy, function () {
        //            $('.zhx_box .city').append('<a href="javascript:;">' + this + '</a>');
        //        });
        //        if (start[1] != -1) {
        //            $('.zhx_box .city a').eq(start[1]).addClass("active");
        //        }
        //        $('.zhx_box .zhx_box_title .active').removeClass("active");
        //        $('.zhx_box .zhx_box_title li').eq(1).addClass("active");
        //        $('.zhx_box .province').hide();
        //        $('.zhx_box .city').show();
        //    }
        //    layer.open({
        //        type: 1,
        //        title: '地区选择',
        //        content: $('.zhx_box'),
        //        offset: 'lb',
        //        area: ['100%', '500px'],
        //        shade: 0.5,
        //        scrollbar: false,
        //        anim: 2
        //    });
        //})
        //$(".stop_city").click(function () {
        //    cityshow = 'stop';
        //    if (stop[0] == -1) {
        //        $('.zhx_box .zhx_box_title li').eq(1).addClass("click-off");
        //        $('.zhx_box .province .active').removeClass("active");
        //        $('.zhx_box .city .active').removeClass("active");
        //        $('.zhx_box .zhx_box_title .active').removeClass("active");
        //        $('.zhx_box .zhx_box_title li').eq(0).addClass("active");
        //        $('.zhx_box .province').show();
        //        $('.zhx_box .city').hide();

        //    } else {
        //        var _cdsy = dsy.get('0_' + stop[0]);
        //        $('.zhx_box .province .active').removeClass("active");
        //        $('.zhx_box .province a').eq(stop[0]).addClass("active");
        //        $('.zhx_box .city').html('');
        //        $.each(_cdsy, function () {
        //            $('.zhx_box .city').append('<a href="javascript:;">' + this + '</a>');
        //        });
        //        if (stop[1] != -1) {
        //            $('.zhx_box .city a').eq(stop[1]).addClass("active");
        //        }
        //        $('.zhx_box .zhx_box_title .active').removeClass("active");
        //        $('.zhx_box .zhx_box_title li').eq(1).addClass("active");
        //        $('.zhx_box .province').hide();
        //        $('.zhx_box .city').show();
        //    }
        //    layer.open({
        //        type: 1,
        //        title: '地区选择',
        //        content: $('.zhx_box'),
        //        offset: 'lb',
        //        area: ['100%', '500px'],
        //        shade: 0.5,
        //        scrollbar: false,
        //        anim: 2
        //    });
        //})

        //$(".car_type").click(function () {
        //    layer.open({
        //        type: 1,
        //        title: '用车类型',
        //        content: $('.zhp_box'),
        //        offset: 'lb',
        //        area: ['100%', 'auto'],
        //        shade: 0.5,
        //        scrollbar: false,
        //        anim: 2
        //    });
        //})

        //$(".more").click(function () {
        //    layer.open({
        //        type: 1,
        //        title: '货源筛选',
        //        content: $('.zhj_box'),
        //        offset: 'lb',
        //        area: ['100%', 'auto'],
        //        shade: 0.5,
        //        scrollbar: false,
        //        anim: 2
        //    });
        //})

        //var $dd = $(".cty_box");
        //$dd.each(function () {
        //    $(this).find("a:not('.m_btn')").click(function () {
        //        $(this).addClass("cur").siblings("a:not('.m_btn')").removeClass("cur");
        //    })
        //})
    })
</script>

